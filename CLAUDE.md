# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A containerized Ghost CMS deployment for a photo portfolio website. Uses Ghost with a customized Edge theme, featuring dark/light mode toggle, automated SSL via Let's Encrypt, daily backups, and Nginx reverse proxy. All services run via Docker Compose.

## Common Commands

### Docker Management
```bash
# Start all services
docker-compose up -d

# Stop all services
docker-compose down

# View logs for a specific service
docker-compose logs -f [ghost|db|nginx|certbot|ghost-backup]

# Restart a specific service
docker-compose restart [service-name]

# Rebuild nginx after config changes
docker-compose build nginx && docker-compose up -d nginx

# Update Ghost to latest version
docker-compose pull ghost && docker-compose up -d ghost
```

### SSL & Certificate Management
```bash
# Initial setup (run once)
./init-letsencrypt.sh

# Check certificate status
docker-compose exec certbot certbot certificates

# Reload nginx after certificate renewal (usually automatic)
docker-compose exec nginx nginx -s reload
```

### Backup & Restore
```bash
# Manual backup
./backup.sh

# Automatic backups run daily at 2 AM via ghost-backup service
```

### Theme Development
```bash
# Navigate to theme directory
cd ghost/content/themes/tfeuerbach-photos/

# Install dependencies (first time only)
yarn install

# Development mode with live reload
yarn dev

# Run theme validation
yarn test

# Build production assets
gulp build

# Create distributable zip
yarn zip
```

## Architecture

### Service Structure

**Services communicate via `app-network` Docker bridge network. Only ports 80/443 are exposed to the host.**

- **ghost**: Ghost CMS (latest) - Node.js application running on port 2368 internally
- **db**: MySQL 8.0 - Database backend, not exposed externally
- **nginx**: Custom Alpine-based reverse proxy with SSL termination
- **certbot**: Automated Let's Encrypt SSL certificate management with 12-hour renewal checks
- **ghost-backup**: Daily backup service (2 AM) using bennetimo/ghost-backup

### Storage Strategy

**Git-tracked:**
- Theme files in `ghost/content/themes/tfeuerbach-photos/`
- Infrastructure: `docker-compose.yml`, nginx configs, scripts
- Theme customizations, especially `dark-mode.css` and `dark-mode.js`

**Host-mounted volumes:**
- `./ghost/content/themes` - Theme files (tracked)
- `./ghost/content/images` - User-uploaded photos (not tracked)
- `./certbot/conf` - SSL certificates (not tracked)
- `./certbot/www` - ACME challenge files (not tracked)
- `./backups` - Backup archives (not tracked)

**Docker volumes:**
- `db_data` - MySQL database
- `ghost_data` - Ghost application data (settings, database)
- `nginx_logs` - Nginx access and error logs

### Environment Configuration

Environment variables are stored in `.env` (not tracked). See `.env.example` for template.

Required variables:
- `MYSQL_ROOT_PASSWORD`, `MYSQL_USER`, `MYSQL_PASSWORD`, `MYSQL_DATABASE`
- `DOMAIN` - Primary domain for the site
- `EMAIL` - Email for Let's Encrypt notifications

Optional:
- `GMAIL_USER`, `GMAIL_APP_PASSWORD` - For Ghost to send emails

## Ghost Theme: tfeuerbach-photos

Based on Ghost's Edge theme with custom enhancements.

### Theme Structure

```
ghost/content/themes/tfeuerbach-photos/
├── assets/
│   ├── built/          # Compiled CSS/JS (generated by gulp)
│   ├── css/
│   │   ├── screen.css  # Main import file
│   │   ├── general/    # Base styles, fonts, variables, masonry
│   │   ├── site/       # Header, layout
│   │   ├── blog/       # Article, feed, post, related posts
│   │   └── misc/       # dark-mode.css, mobile-responsive, pswp (PhotoSwipe)
│   ├── js/
│   │   ├── main.js     # Main JS entry
│   │   └── lib/
│   │       ├── dark-mode.js      # Theme toggle logic with localStorage
│   │       └── masonry.pkgd.min.js
│   ├── fonts/
│   └── images/
├── partials/           # Handlebars partials (loop, pswp, feature-image, related-posts)
├── *.hbs              # Templates (default, index, page, post)
├── package.json
└── gulpfile.js
```

### Build System

Uses **Gulp** for asset compilation:
- **CSS**: PostCSS with `postcss-easy-import`, `autoprefixer`, `cssnano`
- **JS**: Concatenates shared theme assets + custom lib files + main.js, then uglifies
- **Live reload**: Watches `.hbs`, `.css`, and `.js` files

The build process:
1. Imports from `@tryghost/shared-theme-assets` (Ghost's base theme assets)
2. Compiles all CSS imports from `assets/css/screen.css`
3. Concatenates JS files in order: shared assets → lib/*.js → main.js
4. Outputs to `assets/built/` with sourcemaps

### Dark Mode Implementation

**Custom feature - not in original Edge theme.**

Located in:
- `assets/css/misc/dark-mode.css` - CSS variables and toggle button styles
- `assets/js/lib/dark-mode.js` - Toggle logic with localStorage persistence
- `default.hbs:43-45` - Toggle button in header
- `default.hbs:96` - Script include

The dark mode toggle uses CSS variables defined in `:root` and `.dark-mode` class. User preference is stored in localStorage and applied on page load before render to prevent flash.

### Template Files

- `default.hbs` - Main layout with header (including dark mode toggle), footer, and site structure
- `index.hbs` - Home page (posts feed)
- `post.hbs` - Individual post template
- `page.hbs` - Static page template
- `partials/loop.hbs` - Post card/grid rendering
- `partials/pswp.hbs` - PhotoSwipe lightbox markup
- `partials/feature-image.hbs` - Featured image rendering
- `partials/related-posts.hbs` - Related posts section

### Modifying the Theme

**After editing CSS or JS:**
```bash
cd ghost/content/themes/tfeuerbach-photos/
gulp build  # or yarn dev for watch mode
docker-compose restart ghost
```

**After editing .hbs templates:**
```bash
docker-compose restart ghost
```

Ghost caches theme files, so restart is required to see changes.

## Nginx Configuration

Located in `nginx/`:
- `Dockerfile` - Alpine-based build with OpenSSL
- `nginx.conf` - Main nginx configuration
- `sites-available/default` - Virtual host config (proxies to ghost:2368)
- `entrypoint.sh` - Startup script for SSL certificate handling

The nginx service:
1. Terminates SSL/TLS (certificates from Let's Encrypt via certbot)
2. Proxies requests to Ghost container on port 2368
3. Serves ACME challenge files for certificate validation
4. Enables compression and caching headers

## Scripts

### init-letsencrypt.sh

One-time setup script that:
1. Downloads TLS parameters (dhparam.pem)
2. Creates temporary self-signed certificates
3. Starts services
4. Obtains real Let's Encrypt certificates
5. Reloads nginx with real certificates

Run after initial deployment or when changing domains.

### backup.sh

Manual backup script that creates timestamped archives:
- Ghost content (themes, images, data)
- MySQL database dump
- SSL certificates
- Configuration files (docker-compose.yml, .env, nginx/)

Saved to `./backups/manual/`.

Automated backups run daily via the ghost-backup service and are saved to `./backups/`.

## Development Workflow

### Working on Theme

1. Make theme changes in `ghost/content/themes/tfeuerbach-photos/`
2. If changing CSS/JS: run `yarn dev` for live reload
3. If changing templates: restart Ghost container
4. Test changes locally
5. Commit theme changes to git

### Working on Infrastructure

1. Modify docker-compose.yml or nginx configs
2. Rebuild affected services: `docker-compose build [service]`
3. Restart: `docker-compose up -d [service]`
4. Check logs: `docker-compose logs -f [service]`
5. Commit infrastructure changes to git

### Changing Domain

1. Update `DOMAIN` in `.env`
2. Remove old certificates: `sudo rm -rf ./certbot/conf/*`
3. Re-run: `./init-letsencrypt.sh`
4. Update Ghost URL in admin panel if needed

## Troubleshooting

**Ghost won't start:**
- Check database connection: `docker-compose logs db ghost`
- Verify environment variables in `.env`
- Ensure MySQL is healthy: `docker-compose ps`

**SSL certificate issues:**
- Verify DNS points to server (A records)
- Check ports 80/443 are open
- If using Cloudflare, set SSL mode to "Full" (not "Full (strict)")
- Reset: `docker-compose down && sudo rm -rf ./certbot/conf/* && ./init-letsencrypt.sh`

**Theme not updating:**
- Restart Ghost: `docker-compose restart ghost`
- Rebuild assets: `cd ghost/content/themes/tfeuerbach-photos/ && gulp build`
- Clear browser cache

**Database issues:**
- Check MySQL container: `docker-compose logs db`
- Verify credentials in `.env` match `docker-compose.yml`
- Manual database access: `docker-compose exec db mysql -u${MYSQL_USER} -p${MYSQL_PASSWORD} ${MYSQL_DATABASE}`

## Important Notes

- **Never commit `.env` file** - contains sensitive credentials
- **Never commit `ghost/content/images/`** - user-uploaded content, can be large
- **Do commit theme changes** - `ghost/content/themes/tfeuerbach-photos/` is tracked
- **Backups run automatically** at 2 AM daily, check `./backups/` directory
- **Certificate renewal is automatic** - certbot checks every 12 hours
- Ghost admin panel is at `https://yourdomain.com/ghost`
- Theme validation: `cd ghost/content/themes/tfeuerbach-photos/ && yarn test` (runs gscan)
