version: '3.8'

services:
  # MySQL Database
  db:
    image: mysql:8.0
    container_name: photo-portfolio-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Ghost Application
  ghost:
    image: ghost:latest
    container_name: photo-portfolio-ghost
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Database connection
      database__client: mysql
      database__connection__host: db
      database__connection__user: ${MYSQL_USER}
      database__connection__password: ${MYSQL_PASSWORD}
      database__connection__database: ${MYSQL_DATABASE}
      
      # Ghost configuration
      url: https://${DOMAIN}
      server__port: 2368
      server__host: 0.0.0.0
      
      # Mail configuration (optional)
      mail__transport: SMTP
      mail__options__service: Gmail
      mail__options__auth__user: ${GMAIL_USER:-}
      mail__options__auth__pass: ${GMAIL_APP_PASSWORD:-}
      
      # Node environment
      NODE_ENV: production
    volumes:
      # Only mount themes (tracked in git) and images (prevent container bloat)
      - ./ghost/content/themes:/var/lib/ghost/content/themes
      - ./ghost/content/images:/var/lib/ghost/content/images
      # Everything else uses Docker volumes
      - ghost_data:/var/lib/ghost/content/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2368"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx Reverse Proxy
  nginx:
    build: 
      context: ./nginx
      dockerfile: Dockerfile
    container_name: photo-portfolio-nginx
    restart: unless-stopped
    depends_on:
      - ghost
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN=${DOMAIN}
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot:ro
      - nginx_logs:/var/log/nginx
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Certbot for SSL certificates renewal
  certbot:
    image: certbot/certbot:latest
    container_name: photo-portfolio-certbot
    restart: unless-stopped
    entrypoint: ""
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    command: >
      sh -c "trap exit TERM; while :; do certbot renew --quiet; sleep 12h & wait $${!}; done"
    depends_on:
      - nginx
    networks:
      - app-network

  # Ghost Backup Service
  ghost-backup:
    image: bennetimo/ghost-backup
    container_name: photo-portfolio-backup
    restart: unless-stopped
    depends_on:
      - db
      - ghost
    environment:
      BACKUP_DATABASE: "true"
      BACKUP_CONTENT: "true"
      BACKUP_SCHEDULE: "0 2 * * *"  # Daily at 2 AM
      MYSQL_HOST: db
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - ./backups:/backups
      # Mount both host directories and docker volume for complete backup
      - ./ghost/content/themes:/var/lib/ghost/content/themes:ro
      - ./ghost/content/images:/var/lib/ghost/content/images:ro
      - ghost_data:/var/lib/ghost/content/data:ro
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  db_data:
    driver: local
  ghost_data:
    driver: local
  nginx_logs:
    driver: local
